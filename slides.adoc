= Test Me Up, before you Go-Go!
:imagesdir: images
:source-highlighter: highlightjs
:revealjs_theme: white
:revealjs_history: true
:revealjs_slideNumber: true
:revealjs_showSlideNumber: speaker
:revealjs_defaultTiming: 37
:customcss: custom.css
:icons: font
:title-slide-transition: zoom
:title-slide-transition-speed: fast
// nsl, cloudnord, bdxio
:conf: nsl 

image:{conf}.jpg[]

== Qui je suis ?

icon:twitter[] @NicolasComet +
icon:github[] https://github.com/ncomet +

‚òÅÔ∏èüéÆ  *Streaming Team*  ‚òÅÔ∏èüéÆ

*@*

image::ubisoft.jpg[] 

== Testcontainers

* Librairie `Java` (2015)
** JUnit 4 : `@Rule`/`@ClassRule`
** JUnit 5 : `@Testcontainer` extension

[%notitle]
== Dans quel cadre ?

image::microtests.jpg[]

source : https://martinfowler.com/articles/microservice-testing/[_M. Fowler "microservices testing"_] 

== Concepts

* Docker en pr√©requis
* TUs, TC dans un contexte `docker`
* Conteneur(s) jettable(s)
** Scop√©s au test/testsuite

== Testcontainers vs. m√©moire ?

Tester avec les impl√©mentations *concr√®tes*

image::hexagonal.png[width=50%]

source: https://bit.ly/3elq5cT

== Ex : BDD relationnelle

https://phauer.com/2017/dont-use-in-memory-databases-tests-h2/

* Migration sch√©mas ?
* Donn√©es existantes ?
* Sp√©cificit√©s, _joyeuset√©s_ (Date/Time) ?
* Diff√©rents standards ?

== Go - domaine

[source, go]
----
package domain

type PEGI int
type GameId string

type Game struct {
	Id    GameId
	Title string
	PEGI  PEGI
}

type AllGames interface {
	All() []*Game
	Add(*Game)
	Remove(*Game)
	By(GameId) *Game
}
----

== Go - Entrepot Mongo

[source, go]
----
package mongo

type AllGames struct {
	client *mongo.Client
	coll   *mongo.Collection
}

func (a AllGames) Add(game *domain.Game) {
	ctx, cancel := context.WithTimeout(
		context.Background(),
		5*time.Second,
	)
	defer cancel()
	_, err := a.coll.ReplaceOne(ctx, bson.D{{"_id", game.Id}},
		bson.D{
			{"title", game.Title},
			{"PEGI", game.PEGI},
		}, options.Replace().SetUpsert(true))
...
}
...
----

== Go - TestContainers 1/2

[source, go]
----
req := testcontainers.ContainerRequest{
    Image:        "mongo:5.0.8",
    ExposedPorts: []string{"27017/tcp"},
    WaitingFor:   wait.ForListeningPort(nat.Port("27017")),
}

container, err := testcontainers.GenericContainer(
    ctx, 
    testcontainers.GenericContainerRequest{
        ContainerRequest: req,
        Started:          true,
})
...
----

== Go - TestContainers 2/2

[source, go]
----
hostIP, err := container.Host(ctx)
mPort, err := container.MappedPort(
    ctx, 
    nat.Port("27017"),
)

uri := fmt.Sprintf("mongodb://%s:%s", hostIP, mPort)
----

== Go - TestMain

[source, go]
----
func TestMain(m *testing.M) {    
    ctx := context.Background()
    client, err := mdriver.Connect(
        ctx, 
        options.Client().ApplyURI(uri),
    )
	
    allGames = mongo.NewAllGames(client)
		
    defer func() {
        if err = client.Disconnect(ctx); err != nil {
            panic(err)
        }
    }()
    
   os.Exit(m.Run())
}
----

== Test all the things !

[source, go]
----
func Test_Add(t *testing.T) {
	gameId := domain.GameId(uuid.NewString())

	allGames.Add(&domain.Game{
		Id:    gameId,
		Title: "Assassin's Creed Valhalla",
		PEGI:  domain.Eighteen,
	})

	game := allGames.By(gameId)
	assert.Equal(t, gameId, game.Id)
	assert.Equal(t, "Assassin's Creed Valhalla", game.Title)
	assert.Equal(t, domain.Eighteen, game.PEGI)
}
----

== Repository

image::qr-code-testcontainers-go.png[width=50%]

== CI/CD

* Docker runner + Docker socket binding
* Docker in Docker (dind), Service sous gitlab

NOTE: Donner l'acc√®s √† votre runner au d√©mon Docker

== Langages

image::testcontainers-languages.jpg[]

== Slides

image::qr-code-slides.png[width=50%]

[%notitle]
== Questions ?

image::ravingquestion.jpg[background, size=cover]




